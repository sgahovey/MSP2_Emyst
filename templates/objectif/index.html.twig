{% extends 'base.html.twig' %}

{% block title %}Objectifs sportifs{% endblock %}

{% block body %}
<div class="container p-4" style="max-width: 1200px;">
    <h1 class="mb-4">Objectifs sportifs</h1>

    <div class="row g-4">
        <!-- ==========================
             COLONNE GAUCHE (8)
        =========================== -->
        <div class="col-md-8">

            <!-- Mes objectifs -->
            <div class="card p-3 mb-4 objectifs-card">
                <h4 class="mb-3">Mes objectifs</h4>

                <table class="objectifs-table-figma">
                    <thead>
                        <tr>
                            <th>Objectif</th>
                            <th>Valeur cible</th>
                            <th>Échéance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for objectif in objectifs %}
                        <tr>
                            <td>{{ objectif.typeObjectif ? objectif.typeObjectif.value : '' }}</td>
                            <td>{{ objectif.valeurCible }}</td>
                            <td>{{ objectif.dateLimite ? objectif.dateLimite|date('d/m/Y') ~ ' à ' ~ objectif.dateLimite|date('H:i') : '' }}</td>
                            <td>
                               <a class="btn-modifier-figma" href="{{ path('app_objectif_index', { edit: objectif.id }) }}">Modifier</a>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="4">Aucun objectif pour le moment.</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>

                {# <a class="btn btn-success mt-2" href="{{ path('app_objectif_new') }}">Nouvel objectif</a> #}
            </div>

            <!-- Progression -->
            <div class="card p-3 objectifs-card">
                <h4 class="mb-3">Progression par objectif</h4>
                <div class="progression-chart-container">
                    <canvas id="objectifsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ==========================
             COLONNE DROITE (FORMULAIRE)
        =========================== -->
        <div class="col-md-4">
            <div class="card p-3 form-card" style="position: sticky; top: 20px;">
                <h4 class="mb-3">
                    {% if editMode %}
                        Modifier un objectif
                    {% else %}
                        Créer un objectif
                    {% endif %}
                </h4>

                {{ form_start(form, { attr: { class: 'seance-form' } }) }}


                <div class="mb-3">
                    {{ form_label(form.type_objectif, "Type d'objectif", { label_attr: { class: 'form-label' } }) }}
                    {{ form_widget(form.type_objectif, { attr: { class: 'form-control' } }) }}
                </div>

                <div class="mb-3">
                    {{ form_label(form.valeur_cible, "Valeur cible", { label_attr: { class: 'form-label' } }) }}
                    {{ form_widget(form.valeur_cible, { attr: { class: 'form-control' } }) }}
                </div>

                <div class="mb-3">
                    {{ form_label(form.date_limite, "Échéance", { label_attr: { class: 'form-label' } }) }}
                    {{ form_widget(form.date_limite, { attr: { class: 'form-control' } }) }}
                </div>

                <div class="d-flex">
                    <button class="btn btn-primary">Enregistrer</button>
                    <a href="{{ path('app_objectif_index') }}" class="btn btn-secondary ms-2">Annuler</a>
                </div>

                {{ form_end(form) }}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('objectifsChart');
    if (!ctx) return;

    const objectifsData = [
        {% for objectif in objectifs %}
        {
            label: {{ (objectif.typeObjectif ? objectif.typeObjectif.value : '')|json_encode|raw }},
            valeur: {{ objectif.valeurCible|json_encode|raw }},
            date: {{ (objectif.dateLimite ? objectif.dateLimite|date('d/m/Y') : '')|json_encode|raw }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    if (objectifsData.length === 0) {
        ctx.parentElement.innerHTML = '<p style="color: rgba(255, 255, 255, 0.5); text-align: center; padding: 40px;">Aucune donnée à afficher</p>';
        return;
    }

    const labels = objectifsData.map(o => o.label);
    const valeurs = objectifsData.map(o => o.valeur);

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Valeur cible',
                data: valeurs,
                backgroundColor: 'rgba(96, 165, 250, 0.6)',
                borderColor: 'rgba(110, 231, 183, 1)',
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 36, 0.9)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: 'rgba(110, 231, 183, 0.3)',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            return 'Échéance: ' + objectifsData[index].date;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
