{% extends 'base.html.twig' %}

{% block title %}Modifier une s√©ance{% endblock %}

{% block body %}
<div class="container seance-new-container" style="max-width: 1400px;">
    <div class="row g-4">
        <!-- ==========================
             COLONNE GAUCHE (FORMULAIRE)
        =========================== -->
        <div class="col-lg-8">
            <div class="seance-new-header">
                <h1 class="seance-new-title">Modifier une s√©ance</h1>
                <p class="seance-new-subtitle">Modifiez les d√©tails et les exercices</p>
            </div>

            <div class="seance-form-card">
                {{ form_start(form, { attr: { class: 'seance-form' } }) }}

                <div class="form-group">
                    {{ form_label(form.date_entrainement, "Date", { label_attr: { class: 'form-label' } }) }}
                    {{ form_widget(form.date_entrainement, { attr: { class: 'form-control' } }) }}
                    {{ form_errors(form.date_entrainement) }}
                </div>

                <div class="form-group">
                    {{ form_label(form.type_seance, "Type", { label_attr: { class: 'form-label' } }) }}
                    {{ form_widget(form.type_seance, { attr: { class: 'form-control' } }) }}
                    {{ form_errors(form.type_seance) }}
                </div>

                {# Champ Dur√©e cach√© - calcul√© automatiquement √† partir des exercices #}
                <div class="form-group" style="display: none;">
                    {{ form_label(form.duree, "Dur√©e", { label_attr: { class: 'form-label' } }) }}
                    {{ form_widget(form.duree, { attr: { class: 'form-control' } }) }}
                    {{ form_errors(form.duree) }}
                </div>

                <div class="exercices-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div>
                            <h3 class="exercices-title">Exercices disponibles</h3>
                            <p class="exercices-subtitle">Cliquez sur le bouton pour voir tous les exercices</p>
                        </div>
                        <button type="button" class="btn btn-open-exercices-modal" id="btn-open-exercices-modal">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                                <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Voir les exercices
                        </button>
                    </div>
                    
                    <!-- Modal pour les exercices -->
                    <div id="exercices-modal" class="exercices-modal">
                        <div class="exercices-modal-overlay"></div>
                        <div class="exercices-modal-content">
                            <div class="exercices-modal-header">
                                <div>
                                    <h3 class="exercices-modal-title">S√©lectionner des exercices</h3>
                                    <p class="exercices-modal-subtitle" id="exercices-selected-count">0 exercice(s) s√©lectionn√©(s)</p>
                                </div>
                                <button type="button" class="btn-close-modal" id="btn-close-exercices-modal">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="exercices-modal-body">
                                <div id="exercices-available" class="exercices-grid">
                                    {% for exercice in exercices %}
                            <div class="exercice-card exercice-card-available" data-exercice-id="{{ exercice.id }}" data-exercice-nom="{{ exercice.nom }}" data-exercice-default-rep="{{ exercice.repetitions ?? 0 }}" data-exercice-default-charge="{{ exercice.charge ?? 0 }}">
                                <div class="exercice-card-image">
                                    {% set imagePath = null %}
                                    {% if exercice.imageUrl %}
                                        {# Si imageUrl contient d√©j√† "image/", l'utiliser tel quel #}
                                        {% if exercice.imageUrl starts with 'image/' %}
                                            {% set imagePath = exercice.imageUrl %}
                                        {# Si imageUrl commence par "/", c'est un chemin absolu #}
                                        {% elseif exercice.imageUrl starts with '/' %}
                                            {% set imagePath = exercice.imageUrl|slice(1) %}
                                        {# Sinon, ajouter le pr√©fixe "image/" #}
                                        {% else %}
                                            {% set imagePath = 'image/' ~ exercice.imageUrl %}
                                        {% endif %}
                                    {% else %}
                                        {# Fallback : utiliser le nom de l'exercice en minuscules #}
                                        {% set imageName = exercice.nom|lower|replace({' ': ''}) ~ '.jpg' %}
                                        {% set imagePath = 'image/' ~ imageName %}
                                    {% endif %}
                                    <img src="{{ asset(imagePath) }}" alt="{{ exercice.nom }}" loading="lazy" decoding="async">
                                    <div class="exercice-card-placeholder" style="display: none;">
                                        <span>üí™</span>
                                    </div>
                                </div>
                                <div class="exercice-card-content">
                                    <h4 class="exercice-card-name">{{ exercice.nom }}</h4>
                                    <div class="exercice-card-details">
                                        {% if exercice.repetitions %}
                                            <span class="exercice-detail-item">
                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M8 2V14M2 8H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                                </svg>
                                                {{ exercice.repetitions }} r√©p.
                                            </span>
                                        {% endif %}
                                        {% if exercice.charge %}
                                            <span class="exercice-detail-item">
                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <rect x="2" y="6" width="12" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
                                                    <path d="M6 2L8 6L10 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                                {{ exercice.charge }} kg
                                            </span>
                                        {% endif %}
                                        {% if exercice.duree %}
                                            <span class="exercice-detail-item">
                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="2"/>
                                                    <path d="M8 4V8L10 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                                </svg>
                                                {{ exercice.duree|date('H:i') }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="exercices-modal-footer">
                                <button type="button" class="btn btn-cancel-modal" id="btn-cancel-exercices-modal">Annuler</button>
                                <button type="button" class="btn btn-validate-exercices" id="btn-validate-exercices" disabled>
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                                        <path d="M16.667 5L7.5 14.167 3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Valider (<span id="validate-count">0</span>)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="exercices-selected-section">
                    <h3 class="exercices-title">Exercices s√©lectionn√©s</h3>
                    <p class="exercices-subtitle">Remplissez les d√©tails pour chaque exercice ‚Ä¢ Cliquez sur "Voir les exercices" pour en ajouter</p>
                    
                    <div id="exercices-selected-list" class="exercices-selected-list">
                        <p class="no-exercices-message" id="no-exercices-message">Aucun exercice s√©lectionn√©. Cliquez sur les exercices ci-dessus pour les ajouter.</p>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-save-seance">Enregistrer les modifications</button>
                </div>

                {{ form_end(form) }}
            </div>
        </div>

        <!-- ==========================
             COLONNE DROITE (R√âCAPITULATIF)
        =========================== -->
        <div class="col-lg-4">
            <div class="seance-summary-card">
                <div class="summary-header">
                    <a href="{{ path('app_seance_index') }}" class="btn btn-view-history">Voir l'historique</a>
                </div>
                
                <div class="summary-content">
                    <h3 class="summary-title">R√©capitulatif</h3>
                    <p class="summary-subtitle">Informations rapides sur la s√©ance en cours (temps estim√©, charge estim√©e)</p>
                    
                    <div class="summary-item">
                        <span class="summary-label">Temps estim√©</span>
                        <span class="summary-value" id="total-duree-estimate">--:--</span>
                    </div>
                    
                    <div class="summary-item">
                        <span class="summary-label">Charge estim√©e</span>
                        <span class="summary-value" id="total-charge-estimate">0 kg</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            'use strict';
            
            const exercicesAvailable = document.getElementById('exercices-available');
            const exercicesSelectedList = document.getElementById('exercices-selected-list');
            const noExercicesMessage = document.getElementById('no-exercices-message');
            let selectedExercices = []; // Exercices ajout√©s √† la s√©ance
            let modalSelectedExercices = []; // Exercices s√©lectionn√©s dans le modal (temporaires)
            
            // Charger les exercices existants de la s√©ance
            {% if seance.seanceExercices is not empty %}
            selectedExercices = [
                {% for seanceExercice in seance.seanceExercices %}
                {
                    id: {{ seanceExercice.exercices.id }},
                    nom: "{{ seanceExercice.exercices.nom|e('js') }}",
                    repetitions: {{ seanceExercice.repetitions ?? 0 }},
                    charge: {{ seanceExercice.charge ?? 0 }},
                    duree: "{{ seanceExercice.duree ? seanceExercice.duree|date('H:i:s') : '00:00:00' }}",
                    ordre: {{ seanceExercice.ordre ?? loop.index }}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ];
            {% endif %}
            
            console.log('Initialisation:', {
                exercicesAvailable: !!exercicesAvailable,
                exercicesSelectedList: !!exercicesSelectedList,
                noExercicesMessage: !!noExercicesMessage,
                selectedExercicesCount: selectedExercices.length
            });
            
            if (!exercicesAvailable || !exercicesSelectedList) {
                console.error('√âl√©ments manquants!', {
                    exercicesAvailable: !!exercicesAvailable,
                    exercicesSelectedList: !!exercicesSelectedList
                });
                return;
            }
            
            // G√©rer le chargement des images
            exercicesAvailable.querySelectorAll('img').forEach(img => {
                if (img.complete && img.naturalHeight !== 0) {
                    img.classList.add('loaded');
                } else {
                    img.addEventListener('load', function() {
                        this.classList.add('loaded');
                    });
                    img.addEventListener('error', function() {
                        const placeholder = this.nextElementSibling;
                        if (placeholder && placeholder.classList.contains('exercice-card-placeholder')) {
                            this.style.display = 'none';
                            placeholder.style.display = 'flex';
                        }
                    });
                }
            });
            
            // Ajouter un exercice √† la liste s√©lectionn√©e
            function addExerciceToSelected(exerciceCard) {
                if (!exerciceCard) {
                    console.error('exerciceCard est null');
                    return;
                }
                
                const exerciceId = exerciceCard.dataset.exerciceId;
                const exerciceNom = exerciceCard.dataset.exerciceNom;
                const defaultRep = parseInt(exerciceCard.dataset.exerciceDefaultRep) || 0;
                const defaultCharge = parseInt(exerciceCard.dataset.exerciceDefaultCharge) || 0;
                
                console.log('Tentative d\'ajout:', { exerciceId, exerciceNom, defaultRep, defaultCharge });
                
                // V√©rifier si l'exercice n'est pas d√©j√† ajout√© (comparaison en string)
                if (selectedExercices.find(e => String(e.id) === String(exerciceId))) {
                    console.log('Exercice d√©j√† ajout√©:', exerciceId);
                    return;
                }
                
                const exerciceData = {
                    id: exerciceId,
                    nom: exerciceNom,
                    repetitions: defaultRep,
                    charge: defaultCharge,
                    duree: '00:00:00',
                    ordre: selectedExercices.length + 1
                };
                
                selectedExercices.push(exerciceData);
                console.log('Exercice ajout√© avec succ√®s:', exerciceData);
                console.log('Liste compl√®te:', selectedExercices);
                renderSelectedExercices();
                updateTotalCharge();
                updateTotalDuree();
            }
            
            // Supprimer un exercice de la liste s√©lectionn√©e
            function removeExerciceFromSelected(exerciceId) {
                selectedExercices = selectedExercices.filter(e => e.id !== exerciceId);
                updateOrdre();
                renderSelectedExercices();
                updateTotalCharge();
                updateTotalDuree();
            }
            
            // Mettre √† jour l'ordre des exercices
            function updateOrdre() {
                selectedExercices.forEach((exercice, index) => {
                    exercice.ordre = index + 1;
                });
            }
            
            // Rendre la liste des exercices s√©lectionn√©s
            function renderSelectedExercices() {
                if (selectedExercices.length === 0) {
                    noExercicesMessage.style.display = 'block';
                    exercicesSelectedList.innerHTML = '';
                    exercicesSelectedList.appendChild(noExercicesMessage);
                    return;
                }
                
                noExercicesMessage.style.display = 'none';
                exercicesSelectedList.innerHTML = '';
                
                selectedExercices.forEach((exercice, index) => {
                    const exerciceItem = document.createElement('div');
                    exerciceItem.className = 'exercice-selected-item';
                    exerciceItem.dataset.exerciceId = exercice.id;
                    exerciceItem.dataset.ordre = exercice.ordre;
                    
                    exerciceItem.innerHTML = `
                        <div class="exercice-selected-info">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h4 class="exercice-selected-name">${exercice.nom}</h4>
                                <div class="exercice-order-buttons">
                                    <button type="button" class="btn-order btn-order-up" ${index === 0 ? 'disabled' : ''} data-exercice-id="${exercice.id}" data-direction="up" title="Monter">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M8 12L4 8M8 12L12 8M8 12V4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                    <button type="button" class="btn-order btn-order-down" ${index === selectedExercices.length - 1 ? 'disabled' : ''} data-exercice-id="${exercice.id}" data-direction="down" title="Descendre">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M8 4L4 8M8 4L12 8M8 4V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="exercice-selected-fields">
                                <div class="field-group">
                                    <label>R√©p√©titions</label>
                                    <input type="number" name="exercices[${exercice.id}][repetitions]" value="${exercice.repetitions}" min="0" class="form-control" data-field="repetitions" data-exercice-id="${exercice.id}">
                                </div>
                                <div class="field-group">
                                    <label>Charge (kg)</label>
                                    <input type="number" name="exercices[${exercice.id}][charge]" value="${exercice.charge}" min="0" class="form-control" data-field="charge" data-exercice-id="${exercice.id}">
                                </div>
                                <div class="field-group">
                                    <label>Dur√©e (HH:MM:SS)</label>
                                    <input type="text" name="exercices[${exercice.id}][duree]" value="${exercice.duree}" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" placeholder="00:00:00" class="form-control" data-field="duree" data-exercice-id="${exercice.id}">
                                    <small style="color: rgba(255,255,255,0.5); font-size: 11px;">Format: HH:MM:SS</small>
                                </div>
                                <input type="hidden" name="exercices[${exercice.id}][exercice_id]" value="${exercice.id}">
                                <input type="hidden" name="exercices[${exercice.id}][ordre]" value="${exercice.ordre}">
                            </div>
                        </div>
                        <button type="button" class="btn-remove-exercice" data-exercice-id="${exercice.id}">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M5 5L15 15M15 5L5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </button>
                    `;
                    
                    exercicesSelectedList.appendChild(exerciceItem);
                });
                
                // Ajouter les event listeners
                attachSelectedExercicesListeners();
                
                // Mettre √† jour la charge totale et la dur√©e totale apr√®s le rendu
                updateTotalCharge();
                updateTotalDuree();
            }
            
            // Calculer et mettre √† jour la charge totale estim√©e
            function updateTotalCharge() {
                let totalCharge = 0;
                
                // Parcourir tous les exercices s√©lectionn√©s
                selectedExercices.forEach(exercice => {
                    // Si l'exercice a d√©j√† √©t√© rendu, prendre la valeur du champ input
                    const chargeInput = document.querySelector(`input[data-field="charge"][data-exercice-id="${exercice.id}"]`);
                    if (chargeInput) {
                        const charge = parseInt(chargeInput.value) || 0;
                        totalCharge += charge;
                    } else {
                        // Sinon, utiliser la valeur de l'objet exercice
                        totalCharge += parseInt(exercice.charge) || 0;
                    }
                });
                
                // Mettre √† jour l'affichage
                const totalChargeElement = document.getElementById('total-charge-estimate');
                if (totalChargeElement) {
                    totalChargeElement.textContent = `${totalCharge} kg`;
                }
            }
            
            // Convertir une dur√©e HH:MM:SS en secondes
            function durationToSeconds(duration) {
                if (!duration || duration === '00:00:00' || duration === '--:--') {
                    return 0;
                }
                
                const parts = duration.split(':');
                if (parts.length !== 3) {
                    return 0;
                }
                
                const hours = parseInt(parts[0]) || 0;
                const minutes = parseInt(parts[1]) || 0;
                const seconds = parseInt(parts[2]) || 0;
                
                return hours * 3600 + minutes * 60 + seconds;
            }
            
            // Convertir des secondes en format HH:MM:SS
            function secondsToDuration(totalSeconds) {
                if (totalSeconds === 0) {
                    return '--:--';
                }
                
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            }
            
            // Calculer et mettre √† jour la dur√©e totale estim√©e
            function updateTotalDuree() {
                let totalSeconds = 0;
                
                // Parcourir tous les exercices s√©lectionn√©s
                selectedExercices.forEach(exercice => {
                    // Si l'exercice a d√©j√† √©t√© rendu, prendre la valeur du champ input
                    const dureeInput = document.querySelector(`input[data-field="duree"][data-exercice-id="${exercice.id}"]`);
                    if (dureeInput) {
                        const duree = dureeInput.value || '00:00:00';
                        totalSeconds += durationToSeconds(duree);
                    } else {
                        // Sinon, utiliser la valeur de l'objet exercice
                        totalSeconds += durationToSeconds(exercice.duree);
                    }
                });
                
                // Mettre √† jour l'affichage
                const totalDureeElement = document.getElementById('total-duree-estimate');
                if (totalDureeElement) {
                    totalDureeElement.textContent = secondsToDuration(totalSeconds);
                }
                
                // Mettre √† jour aussi le champ cach√© du formulaire
                // Chercher le champ dur√©e du formulaire principal (peut avoir diff√©rents noms selon Symfony)
                const dureeFormInput = document.querySelector('input[name*="[duree]"]') || 
                                      document.querySelector('input[name="seance[duree]"]') ||
                                      document.querySelector('input[name="seance_duree"]');
                if (dureeFormInput && totalSeconds > 0) {
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    // Le champ time HTML attend le format HH:MM (sans secondes)
                    const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                    dureeFormInput.value = timeString;
                } else if (dureeFormInput && totalSeconds === 0) {
                    // Si aucune dur√©e, mettre une valeur par d√©faut
                    dureeFormInput.value = '00:00';
                }
            }
            
            // Attacher les listeners aux exercices s√©lectionn√©s
            function attachSelectedExercicesListeners() {
                // Boutons de suppression
                exercicesSelectedList.querySelectorAll('.btn-remove-exercice').forEach(btn => {
                    btn.addEventListener('click', function() {
                        removeExerciceFromSelected(this.dataset.exerciceId);
                    });
                });
                
                // Mise √† jour des valeurs
                exercicesSelectedList.querySelectorAll('input[data-field]').forEach(input => {
                    input.addEventListener('change', function() {
                        // Mettre √† jour la valeur dans l'objet exercice
                        const exerciceId = this.dataset.exerciceId;
                        const field = this.dataset.field;
                        const exercice = selectedExercices.find(e => String(e.id) === String(exerciceId));
                        if (exercice) {
                            if (field === 'charge' || field === 'repetitions') {
                                exercice[field] = parseInt(this.value) || 0;
                            } else {
                                exercice[field] = this.value;
                            }
                        }
                        // Mettre √† jour la charge totale ou la dur√©e totale
                        if (field === 'charge') {
                            updateTotalCharge();
                        } else if (field === 'duree') {
                            updateTotalDuree();
                        }
                    });
                    
                    // √âcouter aussi les √©v√©nements input pour mise √† jour en temps r√©el
                    input.addEventListener('input', function() {
                        if (this.dataset.field === 'charge') {
                            updateTotalCharge();
                        } else if (this.dataset.field === 'duree') {
                            updateTotalDuree();
                        }
                    });
                });
                
                // Boutons de r√©organisation
                initDragDropSelected();
            }
            
            // Boutons de r√©organisation
            function initDragDropSelected() {
                // Event listeners pour les boutons de r√©organisation
                exercicesSelectedList.querySelectorAll('.btn-order').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const exerciceId = this.dataset.exerciceId;
                        const direction = this.dataset.direction;
                        const currentIndex = selectedExercices.findIndex(e => e.id === exerciceId);
                        
                        if (direction === 'up' && currentIndex > 0) {
                            [selectedExercices[currentIndex], selectedExercices[currentIndex - 1]] = 
                            [selectedExercices[currentIndex - 1], selectedExercices[currentIndex]];
                            updateOrdre();
                            renderSelectedExercices();
                        } else if (direction === 'down' && currentIndex < selectedExercices.length - 1) {
                            [selectedExercices[currentIndex], selectedExercices[currentIndex + 1]] = 
                            [selectedExercices[currentIndex + 1], selectedExercices[currentIndex]];
                            updateOrdre();
                            renderSelectedExercices();
                        }
                    });
                });
            }
            
            // Toggle la s√©lection d'un exercice dans le modal
            function toggleExerciceSelection(exerciceCard) {
                const exerciceId = exerciceCard.dataset.exerciceId;
                const exerciceNom = exerciceCard.dataset.exerciceNom;
                const defaultRep = parseInt(exerciceCard.dataset.exerciceDefaultRep) || 0;
                const defaultCharge = parseInt(exerciceCard.dataset.exerciceDefaultCharge) || 0;
                
                // V√©rifier si l'exercice est d√©j√† s√©lectionn√© dans le modal
                const index = modalSelectedExercices.findIndex(e => String(e.id) === String(exerciceId));
                
                if (index > -1) {
                    // D√©s√©lectionner
                    modalSelectedExercices.splice(index, 1);
                    exerciceCard.classList.remove('selected');
                } else {
                    // S√©lectionner
                    const exerciceData = {
                        id: exerciceId,
                        nom: exerciceNom,
                        repetitions: defaultRep,
                        charge: defaultCharge,
                        duree: '00:00:00',
                        ordre: 0 // Sera mis √† jour lors de l'ajout
                    };
                    modalSelectedExercices.push(exerciceData);
                    exerciceCard.classList.add('selected');
                }
                
                updateModalSelectionCount();
            }
            
            // Mettre √† jour le compteur de s√©lection dans le modal
            function updateModalSelectionCount() {
                const count = modalSelectedExercices.length;
                const countElement = document.getElementById('exercices-selected-count');
                const validateCountElement = document.getElementById('validate-count');
                const validateButton = document.getElementById('btn-validate-exercices');
                
                if (countElement) {
                    countElement.textContent = `${count} exercice(s) s√©lectionn√©(s)`;
                }
                
                if (validateCountElement) {
                    validateCountElement.textContent = count;
                }
                
                if (validateButton) {
                    validateButton.disabled = count === 0;
                }
            }
            
            // Valider et ajouter les exercices s√©lectionn√©s
            function validateAndAddExercices() {
                modalSelectedExercices.forEach(exercice => {
                    // V√©rifier si l'exercice n'est pas d√©j√† dans la liste
                    if (!selectedExercices.find(e => String(e.id) === String(exercice.id))) {
                        exercice.ordre = selectedExercices.length + 1;
                        selectedExercices.push(exercice);
                    }
                });
                
                // R√©initialiser la s√©lection du modal
                modalSelectedExercices = [];
                exercicesAvailable.querySelectorAll('.exercice-card-available').forEach(card => {
                    card.classList.remove('selected');
                });
                
                updateModalSelectionCount();
                renderSelectedExercices();
                updateTotalCharge();
                updateTotalDuree();
                closeModal();
            }
            
            // Attacher les √©v√©nements de clic directement sur chaque carte
            function initAvailableExercices() {
                const cards = exercicesAvailable.querySelectorAll('.exercice-card-available');
                console.log('Nombre de cartes trouv√©es:', cards.length);
                
                cards.forEach(card => {
                    card.draggable = false;
                    card.style.cursor = 'pointer';
                    
                    // Ajouter un √©v√©nement de clic sur chaque carte pour la s√©lection dans le modal
                    card.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Clic sur carte:', this);
                        toggleExerciceSelection(this);
                    });
                });
            }
            
            // Initialiser les cartes disponibles
            initAvailableExercices();
            
            // Gestion du modal
            const exercicesModal = document.getElementById('exercices-modal');
            const btnOpenModal = document.getElementById('btn-open-exercices-modal');
            const btnCloseModal = document.getElementById('btn-close-exercices-modal');
            const modalOverlay = exercicesModal ? exercicesModal.querySelector('.exercices-modal-overlay') : null;
            
            function openModal() {
                if (exercicesModal) {
                    exercicesModal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    // R√©initialiser la s√©lection et mettre √† jour le compteur
                    modalSelectedExercices = [];
                    exercicesAvailable.querySelectorAll('.exercice-card-available').forEach(card => {
                        card.classList.remove('selected');
                    });
                    updateModalSelectionCount();
                }
            }
            
            function closeModal() {
                if (exercicesModal) {
                    exercicesModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
            
            if (btnOpenModal) {
                btnOpenModal.addEventListener('click', openModal);
            }
            
            if (btnCloseModal) {
                btnCloseModal.addEventListener('click', closeModal);
            }
            
            if (modalOverlay) {
                modalOverlay.addEventListener('click', closeModal);
            }
            
            // Fermer avec Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && exercicesModal && exercicesModal.classList.contains('active')) {
                    closeModal();
                }
            });
            
            // Bouton Valider
            const btnValidate = document.getElementById('btn-validate-exercices');
            if (btnValidate) {
                btnValidate.addEventListener('click', function() {
                    validateAndAddExercices();
                });
            }
            
            // Bouton Annuler
            const btnCancel = document.getElementById('btn-cancel-exercices-modal');
            if (btnCancel) {
                btnCancel.addEventListener('click', function() {
                    // R√©initialiser la s√©lection
                    modalSelectedExercices = [];
                    exercicesAvailable.querySelectorAll('.exercice-card-available').forEach(card => {
                        card.classList.remove('selected');
                    });
                    updateModalSelectionCount();
                    closeModal();
                });
            }
            
            // Rendre les exercices existants au chargement
            renderSelectedExercices();
            
            // Initialiser le compteur au chargement (apr√®s un court d√©lai pour s'assurer que le DOM est pr√™t)
            setTimeout(function() {
                updateModalSelectionCount();
                updateTotalCharge();
                updateTotalDuree();
            }, 100);
        });
    </script>
{% endblock %}
